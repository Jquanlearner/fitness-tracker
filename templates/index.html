<script>
  let exerciseCount = 0;
  const pastWorkouts = {{ past_workouts | tojson }};

  function addExercise(name = "", sets = "", reps = "", weight = "", notes = "") {
    const container = document.getElementById("exercises");

    const div = document.createElement("div");
    div.classList.add("exercise-line");
    div.setAttribute("data-index", exerciseCount);

    div.innerHTML = `
      <button type="button" class="btn btn-sm btn-danger remove-btn" onclick="removeExercise(${exerciseCount})">üóëÔ∏è</button>
      <input type="text" name="exercise-${exerciseCount}-name" class="form-control" placeholder="Name" value="${name}" required style="min-width: 120px;">
      <input type="number" name="exercise-${exerciseCount}-sets" class="form-control" placeholder="Sets" value="${sets}" required style="width: 80px;">
      <span style="font-weight:bold;">x</span>
      <input type="text" name="exercise-${exerciseCount}-reps" class="form-control" placeholder="Reps" value="${reps}" required style="width: 100px;">
      <span style="font-weight:bold;">@</span>
      <input type="text" name="exercise-${exerciseCount}-weight" class="form-control" placeholder="Weight (lbs)" value="${weight}" required style="width: 120px;">
      <input type="text" name="exercise-${exerciseCount}-notes" class="form-control" placeholder="(notes)" value="${notes}" style="min-width: 150px;">
    `;

    container.appendChild(div);
    exerciseCount++;
    document.getElementById("exercise-count").value = exerciseCount;
  }

  function removeExercise(index) {
    const container = document.getElementById("exercises");
    const card = container.querySelector(`.exercise-line[data-index="${index}"]`);
    if (card) {
      container.removeChild(card);
    }
  }

  function fillFromPrevious(select) {
    const selectedIndex = select.value;
    if (selectedIndex === "") return;

    const workout = pastWorkouts[selectedIndex];
    const exercises = workout.exercises;

    // Clear existing
    document.getElementById("exercises").innerHTML = "";
    exerciseCount = 0;

    // Set workout name dropdown
    const workoutDropdown = document.querySelector('select[name="workout_name"]');
    workoutDropdown.value = workout.workout_name;

    // Add exercises
    for (let ex of exercises) {
      addExercise(ex.name, ex.sets, ex.reps, ex.weight, ex.notes);
    }
  }

  // Clear reuse dropdown if user manually picks a new workout type
  document.addEventListener("DOMContentLoaded", function () {
    const workoutSelect = document.querySelector('select[name="workout_name"]');
    const reuseSelect = document.querySelector('select[onchange="fillFromPrevious(this)"]');

    workoutSelect.addEventListener("change", () => {
      if (reuseSelect.value !== "") {
        reuseSelect.value = "";
        document.getElementById("exercises").innerHTML = "";
        exerciseCount = 0;
        for (let i = 0; i < 4; i++) {
          addExercise();
        }
      }
    });

    for (let i = 0; i < 4; i++) {
      addExercise();
    }
  });
</script>
